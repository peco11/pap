<ion-spinner *ngIf="formLoading$|async;else ticket"></ion-spinner>
<ng-template #ticket>
  <ng-container *ngIf="ticketFormConf$|async as ticketFormConf">
    <ng-container *ngIf="ticketFormConf.step[(pos$|async)||0] as currentStep">
      <ion-card>
        <form
          [formGroup]="ticketForm"
          class="pap-form"
          *ngIf="ticketFormConf.step && ticketFormConf.step[0] &&(recap$|async) === false"
        >
          <div class="pap-form-content">
            <ng-container *ngIf="ticketFormConf.label as label">
              <div [ngClass]="{'pap-form-first-step' : (pos$|async)===0}">
                {{ label }}
              </div>
            </ng-container>

            <ng-container *ngIf="(pos$|async)===0; else otherSteps">
              <ion-label class="pap-form-label-first-step" *ngIf="currentStep.label != null">
                {{ currentStep.label }}
              </ion-label>
            </ng-container>

            <ng-template #otherSteps>
              <ion-label class="pap-form-label" *ngIf="currentStep.label != null">
                {{ currentStep.label }}
              </ion-label>
            </ng-template>

            <ion-input
              *ngIf="['text','phone'].includes(currentStep.type)"
              #focusInput
              class="pap-form-input"
              [type]="currentStep.type|inputType"
              [pattern]="currentStep.type|inputPattern"
              [formControlName]="currentStep.type"
            >
            </ion-input>
            <ion-textarea
              *ngIf="['note'].includes(currentStep.type)"
              #focusInput
              class="pap-form-textarea"
              rows="4"
              [autoGrow]="true"
              placeholder="Eventuali note..."
              [formControlName]="currentStep.type"
            ></ion-textarea>
            <ng-container [ngSwitch]="currentStep.type">
              <div *ngSwitchCase="'switch'" class="pap-form-toggle">
                <ion-toggle block name="toggle" [checked]="currentStep.value"> </ion-toggle>
              </div>
              <div *ngSwitchCase="'checkbox'" class="pap-form-checkbox">
                <ion-checkbox name="checkbox" [checked]="currentStep.value"> </ion-checkbox>
                <ion-label
                  floating
                  [innerHTML]="(currentStep.placeholder||'')| translate: currentStep.translationsObj?.placeholder"
                >
                </ion-label>
              </div>
              <pap-form-location
                *ngSwitchCase="'location'"
                #focusInput
                [formControlName]="currentStep.type"
              >
              </pap-form-location>
              <pap-form-select
                *ngSwitchCase="'trash_type_id'"
                #focusInput
                [formControlName]="currentStep.type"
                [selected]="currentTrashbookType$|async"
                [options]="(trashBookTypesOpts$|async)??[]"
                (ngModelChange)="log($event)"
              ></pap-form-select>
              <pap-form-image-picker
                *ngSwitchCase="'image'"
                #focusInput
                [formControlName]="currentStep.type"
              >
              </pap-form-image-picker>
            </ng-container>
            <ion-item *ngIf="ticketForm.controls[currentStep.type].errors as errors">
              <pap-error-form-handler [errors]="errors"></pap-error-form-handler>
            </ion-item>
          </div>
        </form>
      </ion-card>
      <ng-container *ngIf="formError$|async as error">
        <ion-label color="danger">{{error}}</ion-label>
      </ng-container>

      <div class="pap-form-footer">
        <pap-form-status
          [form]="ticketForm"
          [label]="ticketFormConf.label"
          [currentStep]="currentStep"
          [conf]="ticketFormConf"
          [pos]="pos$|async"
          (nextEvt)="nextStep()"
          (backEvt)="backStep()"
          (sendDataEvt)="sendData()"
          (undoEvt)="close()"
        ></pap-form-status>
      </div>
    </ng-container>
  </ng-container>
</ng-template>
<ion-modal [isOpen]="recap$|async">
  <ng-template>
    <pap-form-recap
      *ngIf="recap$|async"
      [form]="ticketForm"
      [conf]="(ticketFormConf$|async)!"
    ></pap-form-recap>
    <div class="pap-form-footer">
      <div class="pap-form-buttons">
        <div class="pap-form-buttonblock">
          <ion-button
            class="pap-form-button"
            fill="outline"
            shape="round"
            type="button"
            color="light"
            (click)="close()"
          >
            {{ "annulla" | translate }}
          </ion-button>
        </div>
        <div class="pap-form-buttonblock">
          <ion-button class="pap-form-button" type="submit" (click)="sendData()" color="primary">
            <ion-icon color="light" name="checkmark"></ion-icon>
          </ion-button>
        </div>
      </div>
    </div>
  </ng-template>
</ion-modal>
<ion-modal [isOpen]="(formSuccess$|async)">
  <ng-template>
    <ion-card>
      <ion-card-header>
        <ion-card-title>segnalazione presa in carico</ion-card-title>
      </ion-card-header>

      <ion-card-content>
        Gentile utente la informiamo che il ticket Ã¨ stato inviato correttamente. La ricontatteremo
        al piu presto
      </ion-card-content>
    </ion-card>
    <div class="pap-form-footer">
      <div class="pap-form-buttons">
        <div class="pap-form-buttonblock">
          <ion-button class="pap-form-button" type="submit" (click)="close()" color="secondary">
            <ion-icon color="light" name="checkmark"></ion-icon>
          </ion-button>
        </div>
      </div>
    </div>
  </ng-template>
</ion-modal>
